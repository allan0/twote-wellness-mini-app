<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Third Eye - Game</title>
    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Telegram Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #4E342E;
            --text-color: #FFF8E1;
            --button-color: #FFD700;
            --button-text-color: #3E2723;
            --wellness-manager-color: #3E2723;
            --warning-color: #8B0000;
            --challenge-description-color: #3E2723;
            --level-color: #00bcd4;
            --achievement-color: #ff9800;
            --wheel-border-color: #FFD700; /* Gold border */
            --wheel-pointer-color: #E65100; /* Deep orange pointer */
        }
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
            padding-bottom: 70px; /* Space for footer */
        }
        #backgroundVideo {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -1; pointer-events: none; /* Prevent interaction */
        }
        .container { width: 100%; max-width: 800px; margin: 0 auto; padding: 0 15px; position: relative; z-index: 1;}
        .section {
            background: rgba(255, 248, 220, 0.1); backdrop-filter: blur(10px);
            padding: 25px; border-radius: 20px; margin-bottom: 20px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .challenge-div {
            background: #fff; border-radius: 15px; padding: 15px; margin-bottom: 15px;
            text-align: center; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: var(--challenge-description-color);
        }
        .challenge-div h3 { color: var(--challenge-description-color); margin-bottom: 10px; }
        .challenge-div p { color: var(--challenge-description-color); }
        .challenge-div .warning-text { color: var(--warning-color); }
        .challenge-icon { font-size: 2.5em; margin-bottom: 10px; color: var(--text-color); }
        .challenge-div .challenge-icon { color: var(--challenge-description-color); }

        .modal-content { background: var(--bg-color); color: var(--text-color); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        #wheelModal .modal-content { background: rgba(40, 20, 10, 0.9); } /* Darker wheel modal */
        #wheelCanvas { display: block; margin: 15px auto; max-width: 100%; height: auto; border-radius: 50%; }
        #wheelResult { margin-top: 15px; font-size: 1.1em; font-weight: bold; min-height: 30px; color: var(--button-color); }
        #wheelContainer { position: relative; width: 300px; height: 300px; margin: 0 auto; }
        .wheel-pointer {
            position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent;
            border-top: 25px solid var(--wheel-pointer-color); z-index: 10;
        }

        .btn-custom { background-color: var(--button-color); color: var(--button-text-color); border: none; padding: 10px 20px; border-radius: 10px; box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2), -2px -2px 4px rgba(255, 255, 255, 0.2); transition: transform 0.2s, box-shadow 0.2s; }
        .btn-custom:hover, .btn-custom:active, .btn-custom:focus { transform: scale(1.05); box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.3), -4px -4px 8px rgba(255, 255, 255, 0.3); color: var(--button-text-color); background-color: var(--button-color); }
        .btn-danger { background-color: var(--warning-color); color: #fff; border: none; box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2), -2px -2px 4px rgba(255, 255, 255, 0.2); }
        .btn-danger:hover, .btn-danger:active, .btn-danger:focus { transform: scale(1.05); box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.3), -4px -4px 8px rgba(255, 255, 255, 0.3); color: #fff; }
        .locked { opacity: 0.6; pointer-events: none; } /* Disable interaction for locked items */

        header img[src="logo.webp"] { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
        #profilePhoto { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; cursor: pointer; }
        h1, h2, h4 { color: var(--text-color); }
        #wellnessManager h2, #dailyChallenges h2, #tasksSection h2, #gamePage h2, #playerProfile h2 { text-align: center; margin-bottom: 20px; }
        h3 { color: var(--text-color); }
        .warning-text { color: var(--warning-color); font-weight: bold; }

        .footer-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(78, 52, 46, 0.8); padding: 10px 0; z-index: 1000; display: flex; justify-content: space-around; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); backdrop-filter: blur(5px); }
        .footer-nav a { color: var(--text-color); text-decoration: none; font-size: 14px; text-align: center; transition: transform 0.2s; flex: 1; padding: 5px 0; }
        .footer-nav a:hover { transform: scale(1.1); background-color: rgba(255, 255, 255, 0.1); border-radius: 5px; }
        .footer-nav a i { display: block; font-size: 20px; margin-bottom: 3px; }

        .task-icon { font-size: 1.75em; margin-right: 10px; color: var(--text-color); }
        #socialMediaTasks ul { list-style-type: none; padding: 0; }
        #socialMediaTasks li { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; flex-wrap: wrap; }
        #socialMediaTasks li > div { display: flex; align-items: center; margin-right: 10px; margin-bottom: 5px; }
        #socialMediaTasks a { color: var(--text-color); text-decoration: underline; margin-left: 5px; }
        #socialMediaTasks a:hover { text-decoration: none; }
        #socialMediaTasks button { padding: 5px 10px; font-size: 0.9em; }

        #referralTask { margin-top: 20px; }
        #referralTask p { margin-bottom: 10px; }
        #referralTask input[type="text"] { flex-grow: 1; margin-right: 10px; background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: var(--text-color); padding: 8px; border-radius: 5px; }
        #referralTask button { width: 100px; flex-shrink: 0; }

        .wheel-button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .wheel-button { padding: 12px 5px; font-size: 0.9em; text-align: center; }
        .wheel-button i { display: block; font-size: 1.5em; margin-bottom: 5px; }
        .mystery-box-section { text-align: center; margin-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 20px; }
        .mystery-box-section .fa-box-open { font-size: 3em; color: var(--button-color); margin-bottom: 10px; }
        #mysteryBoxCount { font-weight: bold; color: var(--button-color); }

        #levelDisplay { font-size: 1.2em; font-weight: bold; color: var(--level-color); margin-bottom: 15px; text-align: center; }
        #achievementsList { list-style: none; padding: 0; text-align: center; }
        #achievementsList li { display: inline-block; background: rgba(0,0,0, 0.3); color: var(--achievement-color); padding: 5px 10px; border-radius: 15px; margin: 5px; font-size: 0.9em; border: 1px solid var(--achievement-color); }
        #achievementsList li i { margin-right: 5px; }
        .subscription-info { margin-top: 25px; padding-top: 15px; border-top: 1px dashed rgba(255, 255, 255, 0.3); text-align: center; font-size: 0.9em; opacity: 0.8; }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 10px; } .section { padding: 20px; margin-bottom: 15px;}
            .challenge-div { padding: 12px; } .challenge-icon { font-size: 2em; }
            .btn-custom { margin-bottom: 10px; padding: 10px 15px; }
            h1 { font-size: 1.6rem; } h2 { font-size: 1.4rem; } h3 { font-size: 1.2rem; }
            p { font-size: 0.95rem; } .warning-text { font-size: 0.9rem; }
            #socialMediaTasks button { width: auto; margin-left: auto; }
            #referralTask { flex-direction: column; }
            #referralTask input[type="text"] { width: 100%; margin-right: 0; margin-bottom: 10px; }
            #referralTask button { width: 100%; }
            .wheel-button-grid { grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px;}
            .wheel-button { font-size: 0.85em;}
            #wheelContainer, #wheelCanvas { width: 250px; height: 250px; }
            .wheel-pointer { border-left-width: 12px; border-right-width: 12px; border-top-width: 20px;}
        }
        @media (max-width: 576px) {
            .footer-nav a { font-size: 12px; } .footer-nav a i { font-size: 18px; }
            h1 { font-size: 1.4rem; } h2 { font-size: 1.2rem; } h3 { font-size: 1.1rem; }
            p { font-size: 0.875rem; } .challenge-icon { font-size: 1.75em; }
            #socialMediaTasks li { flex-direction: column; align-items: flex-start;}
            #socialMediaTasks li > div { margin-bottom: 8px; } #socialMediaTasks button { width: 100%; margin-top: 5px; }
            header { flex-direction: column; text-align: center;} header > div:last-child { margin-top: 10px; }
            .wheel-button-grid { grid-template-columns: repeat(2, 1fr); } .wheel-button { font-size: 0.8em;}
            #wheelContainer, #wheelCanvas { width: 220px; height: 220px; }
            .wheel-pointer { border-left-width: 10px; border-right-width: 10px; border-top-width: 18px;}
        }

        /* Tables */
        .table { color: var(--text-color); background-color: rgba(0, 0, 0, 0.2); border-radius: 10px; overflow: hidden; margin-top: 15px; border-collapse: separate; border-spacing: 0; }
        .table th, .table td { border-top: 1px solid rgba(255, 255, 255, 0.2); padding: 0.6rem 0.5rem; vertical-align: middle; }
        .table thead th { color: var(--button-color); background-color: rgba(0, 0, 0, 0.4); border-top: none; border-bottom: 2px solid var(--button-color); font-weight: bold; }
        .table tbody tr:first-child td { border-top: none; } .table tbody tr:hover { background-color: rgba(255, 255, 255, 0.1); }
        .table img { max-width: 40px; height: auto; border-radius: 4px; }
        .table-primary td, .table tr.table-primary td { background-color: rgba(var(--bs-primary-rgb, 13, 110, 253), 0.2) !important; }
        .table .table-primary { font-weight: bold; } .table-responsive { border-radius: 10px; } .table-sm th, .table-sm td { padding: 0.4rem 0.4rem; }

        /* Modals */
        .modal-header, .modal-footer { border: none; }
        .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%); }
        .form-range::-webkit-slider-thumb { background-color: var(--button-color); } .form-range::-moz-range-thumb { background-color: var(--button-color); }
    </style>
</head>
<body>
    <video id="backgroundVideo" autoplay muted loop playsinline>
        <source src="cosmic.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div class="container">
        <header class="d-flex justify-content-between align-items-center py-3">
            <div class="d-flex align-items-center">
                <img src="logo.webp" alt="Logo" onerror="this.style.display='none'"> <!-- Hide if logo fails -->
                <h1 style="margin: 0; font-size: 1.8rem;">Third Eye</h1>
            </div>
            <div class="d-flex align-items-center flex-column text-center" id="profileLink">
                <img id="profilePhoto" src="https://via.placeholder.com/40" alt="Profile">
                <span id="profileNameDisplay" style="margin-top: 5px; font-size: 0.9rem; line-height: 1.1;">Guest</span>
                <span id="profileLevelDisplay" style="font-size: 0.8rem; color: var(--level-color);">Level: Novice</span>
                <span id="pointsDisplay" style="font-size: 0.9rem; color: var(--button-color); font-weight: bold;">0 $twote</span>
            </div>
        </header>

        <!-- Sections -->
        <div id="horoscopeForm" class="section" style="display: none;">
            <h2>Enter Your Birthdate</h2>
            <p>To personalize your journey.</p>
            <input type="date" id="birthdate" class="form-control mb-2">
            <button class="btn btn-custom w-100" id="saveHoroscopeBtn">Save & Continue</button>
        </div>

        <div id="wellnessManager" class="section" style="display: none;">
            <h2>Mindfulness Journey</h2>
            <p style="text-align: center;">Select a challenge duration to begin.</p>
            <div id="challengeOptions" class="mt-3"></div>
        </div>

        <div id="dailyChallenges" class="section" style="display: none;">
            <h2 id="challengeTitle">Challenge</h2>
            <div id="dailyChallengeList"></div>
        </div>

        <div id="tasksSection" class="section" style="display: none;">
            <h2>Earn More $twote & Spins</h2>
             <div id="socialMediaTasks">
                 <h3 style="color: var(--text-color); border-bottom: 1px solid var(--button-color); padding-bottom: 5px; margin-bottom: 15px;">Social Tasks (+10 $twote each)</h3>
                 <ul>
                     <li><div><i class="fab fa-telegram-plane task-icon"></i>Join <a href="https://t.me/ThirdEyeXai" target="_blank">Telegram</a></div><button class="btn btn-custom" id="telegramTaskBtn">Verify</button></li>
                     <li><div><i class="fab fa-twitter task-icon"></i>Follow <a href="https://twitter.com/ThirdEyeXai" target="_blank">Twitter</a></div><button class="btn btn-custom" id="twitterTaskBtn">Verify</button></li>
                     <li><div><i class="fab fa-instagram task-icon"></i>Follow <a href="https://instagram.com/ThirdEyeXai" target="_blank">Instagram</a></div><button class="btn btn-custom" id="instagramTaskBtn">Verify</button></li>
                     <li><div><i class="fab fa-youtube task-icon"></i>Subscribe <a href="https://youtube.com/@ThirdEyeXai" target="_blank">YouTube</a></div><button class="btn btn-custom" id="youtubeTaskBtn">Verify</button></li>
                 </ul>
             </div>
             <div id="referralTask" class="mt-4">
                 <h3 style="color: var(--text-color); border-bottom: 1px solid var(--button-color); padding-bottom: 5px; margin-bottom: 15px;">Referral Task (+Bonus Spins!)</h3>
                 <p>Share your link! Both you and your friend earn $twote. You also get bonus spins!</p>
                 <div class="d-flex mb-2">
                     <input type="text" id="referralLink" class="form-control" readonly>
                     <button class="btn btn-custom" id="copyReferralBtn">Copy</button>
                 </div>
                 <button class="btn btn-secondary w-100" id="claimReferralRewardBtn">Simulate Friend Joined (Dev)</button>
             </div>
        </div>

        <div id="gamePage" class="section" style="display: none;">
            <h2>Engage & Earn</h2>
            <div class="text-center mb-3">
                <button class="btn btn-custom" id="dailyCheckInBtn">Daily Check-In</button>
                <p id="countdownDisplay" style="color: var(--button-color); margin-top: 10px; font-size: 0.9em;"></p>
            </div>

            <h3 style="text-align:center; margin-bottom: 15px;">Daily Bonus Wheels</h3>
            <p id="spinInfo" class="text-center" style="font-size: 0.9em; margin-bottom: 15px;">Complete Daily Check-In to enable spins.</p>
            <div class="wheel-button-grid">
                <button class="btn btn-custom wheel-button" data-wheel="energy"><i class="fas fa-bolt"></i>Energy (0)</button>
                <button class="btn btn-custom wheel-button" data-wheel="sigil"><i class="fas fa-magic"></i>Sigil (0)</button>
                <button class="btn btn-custom wheel-button" data-wheel="happiness"><i class="fas fa-smile-beam"></i>Happiness (0)</button>
                <button class="btn btn-custom wheel-button" data-wheel="wellness"><i class="fas fa-heartbeat"></i>Wellness (0)</button>
                <button class="btn btn-custom wheel-button" data-wheel="prosperity"><i class="fas fa-coins"></i>Prosperity (0)</button>
                <button class="btn btn-custom wheel-button" data-wheel="manifestation"><i class="fas fa-star"></i>Manifest (0)</button>
                <button class="btn btn-custom wheel-button" data-wheel="healing"><i class="fas fa-hand-holding-heart"></i>Healing (0)</button>
                <button class="btn btn-info wheel-button" data-wheel="referral"><i class="fas fa-gift"></i>Ref Spins (<span id="referralSpinsCount">0</span>)</button>
            </div>

            <div class="mystery-box-section">
                <i class="fas fa-box-open"></i>
                <h4>Mystery Boxes</h4>
                <p>Earn boxes from streaks & events!</p>
                <p>You have <span id="mysteryBoxCount">0</span> boxes.</p>
                <button class="btn btn-custom" id="openMysteryBoxBtn" disabled>Open a Box</button>
            </div>

             <div class="subscription-info">
                 <p>✨ Premium Tiers Coming Soon! Unlock better rewards, exclusive badges, and more spins!</p>
             </div>
             <div class="section" style="margin-top: 20px; background: rgba(0,0,0,0.1);">
                 <h4 style="text-align: center;">Limited-Time Events</h4>
                 <p style="text-align: center;">Check back soon for seasonal challenges and special events!</p>
             </div>
        </div>

        <div id="playerProfile" class="section" style="display: none;">
            <h2>Player Profile</h2>
            <div class="text-center mb-3">
                <p>Welcome, <strong id="profileNameDisplayInner" style="color: var(--button-color);">Guest</strong>!</p>
                 <div id="levelDisplay">Level: <span id="levelName" style="color: var(--level-color); font-weight:bold;">Novice</span></div>
                <div id="pointsProfileDisplay">Points: <span id="pointsValue" style="color: var(--button-color); font-weight:bold;">0</span> $twote</div>
                <div id="energyLevel">Energy Level: <span id="energyValue" style="color: var(--button-color); font-weight:bold;">0</span>%</div>
                <div id="consecutiveDaysDisplay">Daily Streak: <span id="consecutiveDaysValue" style="color: var(--button-color); font-weight:bold;">0</span> days</div>
                <div id="weeklyStreakDisplay">Weekly Streak: <span id="weeklyStreakValue" style="color: var(--button-color); font-weight:bold;">0</span> weeks</div>
            </div>
             <div class="d-grid gap-2 mb-4">
                 <button class="btn btn-custom" id="connectWalletBtn">Connect Wallet (Soon)</button>
                 <button class="btn btn-custom" id="airdropWithdrawBtn">Withdraw $twote (Soon)</button>
             </div>

             <h3 class="mt-4 text-center" style="color: var(--text-color);">Achievements</h3>
             <ul id="achievementsList" class="mb-4"></ul>

            <h3 class="mt-4" style="color: var(--text-color);">Challenge History</h3>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead><tr><th>Day</th><th>Goal</th><th>NRG In</th><th>NRG Out</th><th>T1 Proof</th><th>T2 Proof</th></tr></thead>
                    <tbody id="profileHistory"></tbody>
                </table>
            </div>

            <h3 class="mt-4" style="color: var(--text-color);">Leaderboard (Top 100)</h3>
             <div class="table-responsive">
                 <table class="table table-sm">
                     <thead><tr><th>Rank</th><th>Name</th><th>Points ($twote)</th></tr></thead>
                     <tbody id="leaderboard"></tbody>
                 </table>
             </div>
             <div class="text-center mt-4">
                 <button class="btn btn-danger mt-3" id="deleteProgressBtn">Delete Progress</button>
             </div>
        </div>
    </div>

    <nav class="footer-nav">
        <a href="#" id="navHome"><i class="fas fa-home"></i>Journey</a>
        <a href="#" id="navTasks"><i class="fas fa-tasks"></i>Tasks</a>
        <a href="#" id="navGame"><i class="fas fa-dice"></i>Engage</a>
        <a href="#" id="navProfile"><i class="fas fa-user-astronaut"></i>Profile</a>
    </nav>

    <!-- Modals -->
    <div class="modal fade" id="energyLogModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="energyLogModalTitle">Energy Log</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body">
                    <p id="energyLogPrompt">How positive is your mind frame?</p>
                    <div class="d-flex align-items-center my-3"><input type="range" min="0" max="100" value="50" class="form-range flex-grow-1 me-3" id="energySlider"><span id="energySliderValue" style="color: var(--button-color); font-weight: bold; min-width: 40px; text-align: right;">50%</span></div>
                    <div id="challengeTasks" style="display: none; margin-top: 20px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px;">
                        <p class="mb-2"><strong>Meditation:</strong> <span id="meditationTask" style="font-style: italic;"></span></p>
                        <p class="mb-1"><strong>Task 1:</strong> <span id="task1Text"></span></p><input type="file" id="task1Proof" class="form-control form-control-sm mb-2" accept="image/*">
                        <p class="mb-1"><strong>Task 2:</strong> <span id="task2Text"></span></p><input type="file" id="task2Proof" class="form-control form-control-sm" accept="image/*">
                        <p class="mt-3 text-center warning-text" id="proofWarning" style="display: none; font-size: 0.9em;">Please upload proof for both tasks.</p>
                    </div>
                </div>
                <div class="modal-footer justify-content-center"><button class="btn btn-custom w-50" id="submitEnergyLog" disabled>Submit</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="enrollModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Enroll in Workshop</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body text-center">
                     <p><strong>Name:</strong> <span id="enrollName"></span></p>
                     <p><strong>Energy Level:</strong> <span id="enrollEnergy" style="color: var(--button-color); font-weight: bold;"></span>%</p>
                     <p id="enrollRequirement" class="warning-text" style="font-size: 0.9em; display: none;">Requires 70% Energy</p>
                     <button class="btn btn-custom mt-3 w-50" id="submitEnrollment" disabled>Submit Enrollment</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="codeModal" tabindex="-1" aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered">
             <div class="modal-content">
                 <div class="modal-header"><h5 class="modal-title">Enter Workshop Code</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div>
                 <div class="modal-body"><input type="text" id="workshopCode" class="form-control mb-3" placeholder="Enter code"><div class="text-center"><button class="btn btn-custom w-50" id="submitCode">Submit</button></div></div>
             </div>
         </div>
     </div>

    <div class="modal fade" id="wheelModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="wheelModalTitle">Spin the Wheel!</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body text-center">
                    <div id="wheelContainer"><div class="wheel-pointer"></div><canvas id="wheelCanvas" width="300" height="300"></canvas></div>
                    <p id="wheelResult">Ready to spin?</p>
                </div>
                <div class="modal-footer justify-content-center"><button class="btn btn-custom" id="spinTheWheelBtn">Spin!</button></div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100"></div>

    <!-- External JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <!-- Main App Script -->
    <script>
        // --- Constants ---
        const dailyGoals = [ { goal: "Wealth", meditation: "Visualize wealth.", task1: "Write 3 financial goals.", task2: "Plan a budget.", points: 5 }, { goal: "Peace", meditation: "Reflect on peace.", task1: "5-min gratitude.", task2: "5-min breathing.", points: 5 }, { goal: "Focus", meditation: "Focus your mind.", task1: "List 3 priorities.", task2: "Organize workspace.", points: 5 }, { goal: "Creativity", meditation: "Boost creativity.", task1: "Brainstorm 5 ideas.", task2: "Draw something.", points: 5 }, { goal: "Confidence", meditation: "Build confidence.", task1: "Write 3 positives.", task2: "Power pose 2 min.", points: 5 }, { goal: "Energy", meditation: "Energize yourself.", task1: "Visualize energy.", task2: "5-min stretch.", points: 5 }, { goal: "Gratitude", meditation: "Cultivate gratitude.", task1: "Write 3 thanks.", task2: "Send a thank-you.", points: 5 } ];
        const sections = ['horoscopeForm', 'wellnessManager', 'dailyChallenges', 'tasksSection', 'gamePage', 'playerProfile'];
        const wheelTypes = ['energy', 'sigil', 'happiness', 'wellness', 'prosperity', 'manifestation', 'healing', 'referral'];
        const levels = [ { name: "Novice", points: 0 }, { name: "Beginner", points: 100 }, { name: "Adept", points: 500 }, { name: "Guardian", points: 1500 }, { name: "Healer", points: 4000 }, { name: "Master", points: 10000 }];
        const achievementsConfig = { 'FIRST_CHECKIN': { name: "First Steps", icon: "fa-shoe-prints", description: "Completed your first daily check-in." }, '7_DAY_STREAK': { name: "Consistent Soul", icon: "fa-calendar-check", description: "Achieved a 7-day streak." }, 'FIRST_REFERRAL': { name: "Community Builder", icon: "fa-users", description: "Successfully referred a friend." }, 'LEVEL_ADEPT': { name: "Adept Achiever", icon: "fa-star", description: "Reached the Adept level." }, 'CHALLENGE_7_COMPLETE': { name: "Foundation Complete", icon: "fa-sun", description: "Completed the 7-Day Foundation Challenge."}, 'OPEN_MYSTERY_BOX': { name: "Curious Explorer", icon: "fa-box", description: "Opened your first Mystery Box." }, };
        const wheelRewardConfigs = { // Colors adjusted for potentially better contrast
            energy: [ { label: "1 $twote", type: "points", value: 1, color: "#C5E1A5" }, { label: "+1% NRG", type: "energy", value: 1, color: "#FFF59D" }, { label: "2 $twote", type: "points", value: 2, color: "#C5E1A5" }, { label: "+2% NRG", type: "energy", value: 2, color: "#FFF59D" }, { label: "3 $twote", type: "points", value: 3, color: "#C5E1A5" }, { label: "Spin Again", type: "spin_again", value: null, color: "#FFCC80" }, { label: "1 $twote", type: "points", value: 1, color: "#C5E1A5" }, { label: "+1% NRG", type: "energy", value: 1, color: "#FFF59D" }, ],
            sigil: [ { label: "2 $twote", type: "points", value: 2, color: "#B3E5FC" }, { label: "3 $twote", type: "points", value: 3, color: "#81D4FA" }, { label: "4 $twote", type: "points", value: 4, color: "#B3E5FC" }, { label: "Small Luck", type: "message", value: "Feeling lucky!", color: "#E1BEE7" }, { label: "5 $twote", type: "points", value: 5, color: "#81D4FA" }, { label: "Spin Again", type: "spin_again", value: null, color: "#FFCC80" }, { label: "2 $twote", type: "points", value: 2, color: "#B3E5FC" }, { label: "1 $twote", type: "points", value: 1, color: "#81D4FA" }, ],
            happiness: [ { label: "+2% NRG", type: "energy", value: 2, color: "#FFE082" }, { label: "3 $twote", type: "points", value: 3, color: "#FFCC80" }, { label: "+3% NRG", type: "energy", value: 3, color: "#FFE082" }, { label: "5 $twote", type: "points", value: 5, color: "#FFCC80" }, { label: "+5% NRG", type: "energy", value: 5, color: "#FFE082" }, { label: "Joyful!", type: "message", value: "Radiate joy!", color: "#FFF59D" }, { label: "Spin Again", type: "spin_again", value: null, color: "#FFCC80" }, { label: "2 $twote", type: "points", value: 2, color: "#FFCC80" }, ],
            wellness: [ { label: "2 $twote", type: "points", value: 2, color: "#C8E6C9" }, { label: "+2% NRG", type: "energy", value: 2, color: "#DCEDC8" }, { label: "4 $twote", type: "points", value: 4, color: "#C8E6C9" }, { label: "+3% NRG", type: "energy", value: 3, color: "#DCEDC8" }, { label: "5 $twote", type: "points", value: 5, color: "#C8E6C9" }, { label: "Healthy Glow", type: "message", value: "Feeling vibrant!", color: "#F0F4C3" }, { label: "Spin Again", type: "spin_again", value: null, color: "#FFCC80" }, { label: "+1% NRG", type: "energy", value: 1, color: "#DCEDC8" }, ],
            prosperity: [ { label: "5 $twote", type: "points", value: 5, color: "#FFE0B2" }, { label: "7 $twote", type: "points", value: 7, color: "#FFCC80" }, { label: "10 $twote", type: "points", value: 10, color: "#FFB74D" }, { label: "Mystery Box", type: "mystery_box", value: 1, color: "#CE93D8" }, { label: "15 $twote", type: "points", value: 15, color: "#FFA726" }, { label: "Spin Again", type: "spin_again", value: null, color: "#FFCC80" }, { label: "5 $twote", type: "points", value: 5, color: "#FFE0B2" }, { label: "Jackpot! 25", type: "points", value: 25, color: "#FF9800" }, ],
            manifestation: [ { label: "3 $twote", type: "points", value: 3, color: "#BBDEFB" }, { label: "+2% NRG", type: "energy", value: 2, color: "#D7CCC8" }, { label: "5 $twote", type: "points", value: 5, color: "#90CAF9" }, { label: "Mystery Box", type: "mystery_box", value: 1, color: "#CE93D8" }, { label: "7 $twote", type: "points", value: 7, color: "#64B5F6" }, { label: "Spin Again", type: "spin_again", value: null, color: "#FFCC80" }, { label: "+5% NRG", type: "energy", value: 5, color: "#D7CCC8" }, { label: "Vision Clear", type: "message", value: "Focus intent!", color: "#E0E0E0" }, ],
            healing: [ { label: "+3% NRG", type: "energy", value: 3, color: "#D1C4E9" }, { label: "2 $twote", type: "points", value: 2, color: "#B39DDB" }, { label: "+5% NRG", type: "energy", value: 5, color: "#D1C4E9" }, { label: "4 $twote", type: "points", value: 4, color: "#9575CD" }, { label: "+7% NRG", type: "energy", value: 7, color: "#D1C4E9" }, { label: "Spin Again", type: "spin_again", value: null, color: "#FFCC80" }, { label: "Restored", type: "message", value: "Feel refreshed!", color: "#FFF59D" }, { label: "1 $twote", type: "points", value: 1, color: "#B39DDB" }, ],
            referral: [ { label: "10 $twote", type: "points", value: 10, color: "#F8BBD0" }, { label: "Mystery Box", type: "mystery_box", value: 1, color: "#CE93D8" }, { label: "20 $twote", type: "points", value: 20, color: "#F48FB1" }, { label: "2 M.Box", type: "mystery_box", value: 2, color: "#CE93D8" }, { label: "30 $twote", type: "points", value: 30, color: "#F06292" }, { label: "Spin Again", type: "spin_again", value: null, color: "#FFCC80" }, { label: "NFT Soon", type: "message", value: "NFT soon!", color: "#80DEEA" }, { label: "50 $twote", type: "points", value: 50, color: "#EC407A" }, ]
        };

        // --- Global State & Utils ---
        let state = {};
        let sectionStack = ['wellnessManager'];
        let domElements = {};
        let energyLogModalInstance, enrollModalInstance, codeModalInstance, wheelModalInstance;
        let currentWheelType = null;
        let wheelSpinning = false;
        let currentRotation = 0;
        let appInitialized = false;

        // --- Utility Functions ---
        function getDomElements() { /* ... (no changes) ... */
             const ids = [ 'profilePhoto', 'profileNameDisplay', 'profileNameDisplayInner', 'pointsDisplay', 'profileLevelDisplay', 'pointsValue', 'consecutiveDaysValue', 'weeklyStreakValue', 'energyValue', 'challengeOptions', 'dailyChallengeList', 'challengeTitle', 'energyLogPrompt', 'energySlider', 'energySliderValue', 'challengeTasks', 'meditationTask', 'task1Text', 'task2Text', 'task1Proof', 'task2Proof', 'submitEnergyLog', 'profileHistory', 'referralLink', 'dailyCheckInBtn', 'countdownDisplay', 'leaderboard', 'enrollName', 'enrollEnergy', 'submitEnrollment', 'workshopCode', 'submitCode', 'proofWarning', 'enrollRequirement', 'energyLogModal', 'enrollModal', 'codeModal', 'wheelModal', 'wheelModalTitle', 'wheelCanvas', 'wheelResult', 'spinTheWheelBtn', 'spinInfo', 'levelDisplay', 'levelName', 'achievementsList', 'mysteryBoxCount', 'openMysteryBoxBtn', 'referralSpinsCount', 'claimReferralRewardBtn', 'copyReferralBtn', 'telegramTaskBtn', 'twitterTaskBtn', 'instagramTaskBtn', 'youtubeTaskBtn' ]; const elements = {}; ids.forEach(id => { const el = document.getElementById(id); elements[id] = el; }); return elements;
        }
        function capitalizeFirstLetter(string) { /* ... (no changes) ... */ return string ? string.charAt(0).toUpperCase() + string.slice(1) : ''; }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => { /* ... (added checks for essential elements and modals) ... */
            console.log("DOM Content Loaded. Initializing..."); if (appInitialized) { console.warn("App already initialized. Skipping."); return; } appInitialized = true; try { domElements = getDomElements(); if (!domElements.challengeOptions || !domElements.dailyChallengeList || !domElements.wheelCanvas) { console.error("Critical DOM elements missing. Aborting."); document.body.innerHTML = "<p style='color: red; padding: 20px;'>Error: UI load failed.</p>"; return; } energyLogModalInstance = domElements.energyLogModal ? new bootstrap.Modal(domElements.energyLogModal) : null; enrollModalInstance = domElements.enrollModal ? new bootstrap.Modal(domElements.enrollModal) : null; codeModalInstance = domElements.codeModal ? new bootstrap.Modal(domElements.codeModal) : null; wheelModalInstance = domElements.wheelModal ? new bootstrap.Modal(domElements.wheelModal) : null; if (!energyLogModalInstance || !enrollModalInstance || !codeModalInstance || !wheelModalInstance) { console.error("Modal initialization failed."); } initializeApp(); setupEventListeners(); console.log("App Initialization complete."); } catch (error) { console.error("Critical init error:", error); document.body.innerHTML = `<p style='color: red; padding: 20px;'>Fatal Error: ${error.message}.</p>`; }
        });
        function initializeState() { /* ... (no changes) ... */ const defaultLeaderboard = [ { userId: 'bot1', name: 'Cosmic Guide', points: 150 }, { userId: 'bot2', name: 'Zen Master', points: 120 }, { userId: 'bot3', name: 'Astro Explorer', points: 110 }, ]; const initialSpins = {}; wheelTypes.forEach(type => initialSpins[type] = 0); return { userId: null, userName: "Guest", userPhoto: "https://via.placeholder.com/40", energyLevel: 0, points: 0, level: "Novice", challenges: [], challengeHistory: [], birthdate: null, consecutiveDays: 0, weeklyStreak: 0, lastPlayedDate: null, lastCheckInTime: null, completedTasks: [], workshopAccess: false, currentChallengeDuration: null, currentChallengeDay: null, energyBefore: null, leaderboard: defaultLeaderboard, achievements: [], mysteryBoxes: 0, wheelSpins: initialSpins, lastDailySpinReset: null, challengeCompletedToday: {}, }; }
        function initializeApp() { /* ... (no changes) ... */ console.log("initializeApp: Starting..."); state = initializeState(); try { if (window.Telegram?.WebApp) { Telegram.WebApp.ready(); Telegram.WebApp.expand(); const user = Telegram.WebApp.initDataUnsafe?.user; if (user && user.id) { state.userId = user.id.toString(); state.userName = user.first_name || "User"; state.userPhoto = user.photo_url || domElements.profilePhoto?.src || "https://via.placeholder.com/40"; console.log("initializeApp: TG user:", state.userId, state.userName); } else { console.warn("initializeApp: TG user data invalid."); state.userId = localStorage.getItem('userId') || `local_${Date.now()}`; } } else { console.warn("initializeApp: TG WebApp unavailable."); state.userId = localStorage.getItem('userId') || `local_${Date.now()}`; } localStorage.setItem('userId', state.userId); console.log("initializeApp: User ID:", state.userId); } catch (tgError) { console.error("initializeApp: TG setup error:", tgError); state.userId = localStorage.getItem('userId') || `local_${Date.now()}`; localStorage.setItem('userId', state.userId); } initLocalStorage(); console.log("initializeApp: Finished."); }
        function initLocalStorage() { /* ... (no changes) ... */ console.log("initLocalStorage: Loading state for user:", state.userId); try { state.energyLevel = parseInt(localStorage.getItem('energyLevel') || '0'); state.points = parseInt(localStorage.getItem('points') || '0'); state.level = localStorage.getItem('level') || "Novice"; state.birthdate = localStorage.getItem('birthdate') || null; state.consecutiveDays = parseInt(localStorage.getItem('consecutiveDays') || '0'); state.weeklyStreak = parseInt(localStorage.getItem('weeklyStreak') || '0'); state.lastPlayedDate = localStorage.getItem('lastPlayedDate') || null; state.lastCheckInTime = localStorage.getItem('lastCheckInTime') ? parseInt(localStorage.getItem('lastCheckInTime')) : null; state.workshopAccess = localStorage.getItem('workshopAccess') === 'true'; state.mysteryBoxes = parseInt(localStorage.getItem('mysteryBoxes') || '0'); state.lastDailySpinReset = localStorage.getItem('lastDailySpinReset') || null; state.challenges = JSON.parse(localStorage.getItem('challenges') || 'null') || initializeChallenges(); state.challengeHistory = JSON.parse(localStorage.getItem('challengeHistory') || '[]'); state.completedTasks = JSON.parse(localStorage.getItem('completedTasks') || '[]'); state.achievements = JSON.parse(localStorage.getItem('achievements') || '[]'); state.challengeCompletedToday = JSON.parse(localStorage.getItem('challengeCompletedToday') || '{}'); const savedLeaderboard = JSON.parse(localStorage.getItem('leaderboard') || 'null') || []; state.leaderboard = mergeLeaderboards(state.leaderboard, savedLeaderboard); const savedSpins = JSON.parse(localStorage.getItem('wheelSpins') || '{}'); wheelTypes.forEach(type => { state.wheelSpins[type] = savedSpins[type] || 0; }); ensureUserInLeaderboard(); console.log("initLocalStorage: State loaded."); checkDailyReset(); updateUserLevel(); updateUI(); startCountdown(); showInitialSection(); } catch (error) { console.error('initLocalStorage: Error loading data.', error); showNotification('Error loading data.', 'error'); if (!Array.isArray(state.challenges)) state.challenges = initializeChallenges(); if (!Array.isArray(state.challengeHistory)) state.challengeHistory = []; if (!Array.isArray(state.completedTasks)) state.completedTasks = []; if (!Array.isArray(state.achievements)) state.achievements = []; if (typeof state.challengeCompletedToday !== 'object' || state.challengeCompletedToday === null) state.challengeCompletedToday = {}; if (typeof state.wheelSpins !== 'object' || state.wheelSpins === null) { const initialSpins = {}; wheelTypes.forEach(type => initialSpins[type] = 0); state.wheelSpins = initialSpins; } if (!Array.isArray(state.leaderboard)) state.leaderboard = []; ensureUserInLeaderboard(); checkDailyReset(); updateUserLevel(); updateUI(); startCountdown(); showInitialSection(); } }

        // --- State Saving & Management ---
        function saveData(keys) { /* ... (no changes) ... */ keys.forEach(key => { if (state[key] === undefined) { console.warn(`Save undefined key: ${key}`); return; } try { let valueToSave; switch (key) { case 'challenges': case 'challengeHistory': case 'completedTasks': case 'leaderboard': case 'achievements': case 'wheelSpins': case 'challengeCompletedToday': valueToSave = JSON.stringify(state[key]); break; case 'workshopAccess': valueToSave = state[key] ? 'true' : 'false'; break; default: valueToSave = state[key]; break; } if (valueToSave !== null && valueToSave !== undefined) { localStorage.setItem(key, valueToSave); } else { localStorage.removeItem(key); } } catch (error) { console.error(`Save error '${key}':`, error); showNotification(`Save Error ${key}`, 'error'); } }); }
        function mergeLeaderboards(defaultBoard, savedBoard) { /* ... (no changes) ... */ const m = [...defaultBoard]; const ids = new Set(m.map(u=>u.userId)); savedBoard.forEach(s => { if (!ids.has(s.userId)) { m.push(s); } else { const d = m.find(u => u.userId === s.userId); if (d && s.points > d.points) d.points = s.points; } }); return m; }
        function ensureUserInLeaderboard() { /* ... (no changes) ... */ const u = state.leaderboard.find(p => p.userId === state.userId); if (!u) { state.leaderboard.push({ userId: state.userId, name: state.userName, points: state.points }); } else { if (u.points !== state.points || u.name !== state.userName) { u.points = state.points; u.name = state.userName; } } }

        // --- UI Update Functions ---
        function showNotification(message, type = 'info') { /* ... (no changes) ... */ if (!document.querySelector('.toast-container')) return; const t = document.createElement('div'); t.className = `toast align-items-center text-bg-${type==='error'?'danger':(type==='success'?'success':'primary')} border-0`; t.setAttribute('role','alert'); t.setAttribute('aria-live','assertive'); t.setAttribute('aria-atomic','true'); t.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`; document.querySelector('.toast-container').appendChild(t); try { const b = new bootstrap.Toast(t, {delay: 3000}); b.show(); t.addEventListener('hidden.bs.toast', () => { t.remove(); }); } catch(e) { console.error("Toast error:", e); t.remove(); } }
        function updateUI() { /* ... (no changes) ... */ if (!domElements) return; if (domElements.profilePhoto) domElements.profilePhoto.src = state.userPhoto || "https://via.placeholder.com/40"; if (domElements.profileNameDisplay) domElements.profileNameDisplay.textContent = state.userName || "Guest"; if (domElements.profileNameDisplayInner) domElements.profileNameDisplayInner.textContent = state.userName || "Guest"; if (domElements.pointsDisplay) domElements.pointsDisplay.textContent = `${state.points || 0} $twote`; if (domElements.pointsValue) domElements.pointsValue.textContent = state.points || 0; if (domElements.consecutiveDaysValue) domElements.consecutiveDaysValue.textContent = state.consecutiveDays || 0; if (domElements.weeklyStreakValue) domElements.weeklyStreakValue.textContent = state.weeklyStreak || 0; if (domElements.energyValue) domElements.energyValue.textContent = state.energyLevel || 0; if (domElements.levelName) domElements.levelName.textContent = state.level || "Novice"; if (domElements.profileLevelDisplay) domElements.profileLevelDisplay.textContent = `Level: ${state.level || "Novice"}`; if (domElements.referralLink && state.userId) { const bot = "ThirdEyeTestDevBot"; domElements.referralLink.value = `https://t.me/${bot}?start=${state.userId}`; } else if (domElements.referralLink) { domElements.referralLink.value = "Link unavailable"; } updateDailyCheckInButtonState(); updateLeaderboardUI(); updateTaskButtons(); updateWheelButtonLabels(); updateWheelButtonsEnablement(); updateAchievementsUI(); updateMysteryBoxUI(); updateReferralSpinsUI(); }
        function updateReferralSpinsUI() { /* ... (no changes) ... */ if (domElements.referralSpinsCount) { domElements.referralSpinsCount.textContent = state.wheelSpins.referral || 0; } }
        function updateDailyCheckInButtonState() { /* ... (no changes) ... */ if (!domElements.dailyCheckInBtn || !domElements.countdownDisplay || !domElements.spinInfo) return; const now = Date.now(); const dayMs = 86400000; const canCheckIn = !state.lastCheckInTime || (now - state.lastCheckInTime >= dayMs); if (canCheckIn) { domElements.dailyCheckInBtn.disabled = false; domElements.dailyCheckInBtn.textContent = "Daily Check-In"; domElements.countdownDisplay.textContent = 'Check-in available!'; domElements.spinInfo.textContent = 'Complete Check-In for spins.'; } else { domElements.dailyCheckInBtn.disabled = true; domElements.dailyCheckInBtn.textContent = "Checked In"; domElements.spinInfo.textContent = 'Spins enabled!'; startCountdown(); } updateWheelButtonsEnablement(); }
        function updateWheelButtonLabels() { /* ... (no changes) ... */ const btns = document.querySelectorAll('.wheel-button'); btns.forEach(b => { const type = b.dataset.wheel; if (!type) return; const spins = state.wheelSpins[type] || 0; const base = b.innerHTML.split('(')[0].trim(); if (type === 'referral') { if (domElements.referralSpinsCount) domElements.referralSpinsCount.textContent = spins; } else { b.innerHTML = `${base} (${spins})`; } }); }
        function updateWheelButtonsEnablement() { /* ... (no changes) ... */ const now = Date.now(); const dayMs = 86400000; const checkedIn = state.lastCheckInTime && (now - state.lastCheckInTime < dayMs); const btns = document.querySelectorAll('.wheel-button'); btns.forEach(b => { const type = b.dataset.wheel; if (!type) return; const spins = state.wheelSpins[type] || 0; const canSpin = checkedIn && spins > 0; b.disabled = !canSpin; if (!checkedIn) b.title = "Check-in first"; else if (spins <= 0) b.title = `No ${capitalizeFirstLetter(type)} spins left`; else b.title = `Spin (${spins} left)`; }); }
        function updateLeaderboardUI() { /* ... (no changes) ... */ if (!domElements.leaderboard) return; state.leaderboard.sort((a, b) => b.points - a.points); domElements.leaderboard.innerHTML = state.leaderboard.slice(0, 100).map((p, i) => `<tr class="${p.userId===state.userId?'table-primary':''}"><td>${i+1}</td><td>${p.name||'Anon'}</td><td>${p.points}</td></tr>`).join(''); if(state.leaderboard.length===0) domElements.leaderboard.innerHTML = '<tr><td colspan="3" class="text-center">Leaderboard empty.</td></tr>'; }
        function updateTaskButtons() { /* ... (no changes) ... */ const bMap = { telegram: domElements.telegramTaskBtn, twitter: domElements.twitterTaskBtn, instagram: domElements.instagramTaskBtn, youtube: domElements.youtubeTaskBtn }; for (const k in bMap) { const b = bMap[k]; if (b) { if (state.completedTasks.includes(k)) { b.disabled = true; b.textContent = 'Done'; b.classList.remove('btn-custom'); b.classList.add('btn-success'); } else { b.disabled = false; b.textContent = 'Verify'; b.classList.remove('btn-success'); b.classList.add('btn-custom'); } } } }
        function updateAchievementsUI() { /* ... (no changes) ... */ if (!domElements.achievementsList) return; if (state.achievements.length === 0) { domElements.achievementsList.innerHTML = '<li><i class="fas fa-hourglass-start"></i> No achievements yet</li>'; return; } domElements.achievementsList.innerHTML = state.achievements.map(k => { const a = achievementsConfig[k]; if (!a) return ''; return `<li title="${a.description}"><i class="fas ${a.icon}"></i> ${a.name}</li>`; }).join(''); }
        function updateMysteryBoxUI() { /* ... (no changes) ... */ if (!domElements.mysteryBoxCount || !domElements.openMysteryBoxBtn) return; domElements.mysteryBoxCount.textContent = state.mysteryBoxes || 0; domElements.openMysteryBoxBtn.disabled = (state.mysteryBoxes || 0) <= 0; }

        // --- Navigation ---
        function showInitialSection() { /* ... (no changes) ... */ const sectionId = state.birthdate ? 'wellnessManager' : 'horoscopeForm'; console.log("showInitialSection:", sectionId); sectionStack = [sectionId]; showSection(sectionId, true); }
        function showSection(sectionId, isInitial = false) { /* ... (no changes) ... */ if (!sectionId || !sections.includes(sectionId)){ console.error(`Invalid section: ${sectionId}. Defaulting.`); sectionId = 'wellnessManager'; isInitial = true; } if (!isInitial && sectionId !== sectionStack[sectionStack.length - 1]) { sectionStack.push(sectionId); } else if (isInitial) { sectionStack = [sectionId]; } sections.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = id === sectionId ? 'block' : 'none'; }); try { if (window.Telegram?.WebApp) { if (sectionStack.length > 1) Telegram.WebApp.BackButton.show(); else Telegram.WebApp.BackButton.hide(); } } catch (e) { console.error("TG back button error:", e); } switch (sectionId) { case 'wellnessManager': if (domElements.challengeOptions) loadChallenges(); break; case 'dailyChallenges': if (domElements.dailyChallengeList) displayDailyChallenges(state.currentChallengeDuration); break; case 'playerProfile': if (domElements.profileHistory && domElements.leaderboard && domElements.achievementsList) { loadProfileHistory(); updateLeaderboardUI(); updateAchievementsUI(); } break; case 'gamePage': if (domElements.spinInfo) { updateWheelButtonLabels(); updateWheelButtonsEnablement(); updateMysteryBoxUI(); updateReferralSpinsUI(); } break; } }
        function setupBackButton() { /* ... (no changes) ... */ try { if (window.Telegram?.WebApp) { Telegram.WebApp.BackButton.onClick(() => { if (sectionStack.length > 1) { sectionStack.pop(); const prev = sectionStack[sectionStack.length - 1]; showSection(prev, true); } else { console.log("Back on first screen."); /* TG close? */ } }); } } catch (e) { console.error("TG back button setup error:", e); } }

        // --- Core Game Logic ---
        function awardPoints(amount, reason = "") { /* ... (no changes) ... */ const pts = parseInt(amount); if (isNaN(pts) || pts <= 0) { console.warn(`Invalid points: ${amount}. Reason: ${reason}.`); return; } state.points += pts; console.log(`+${pts} points. Reason: ${reason}. Total: ${state.points}`); const idx = state.leaderboard.findIndex(p => p.userId === state.userId); if (idx > -1) { state.leaderboard[idx].points = state.points; } else { state.leaderboard.push({ userId: state.userId, name: state.userName, points: state.points }); } updateUserLevel(); saveData(['points', 'leaderboard']); updateUI(); showNotification(`+${pts} $twote! ✨`, 'success'); }
        function updateUserLevel() { /* ... (no changes) ... */ let curLvl = state.level; let newLvl = levels[0].name; for (let i = levels.length - 1; i >= 0; i--) { if (state.points >= levels[i].points) { newLvl = levels[i].name; break; } } if (newLvl !== curLvl) { state.level = newLvl; console.log(`Level up! ${newLvl}`); showNotification(`Level Up: ${newLvl}! 🎉`, 'success'); saveData(['level']); if (newLvl === "Adept") checkAndGrantAchievement('LEVEL_ADEPT'); updateUI(); } }
        function updateEnergyLevel(before = null, after = null) { /* ... (no changes) ... */ if (before !== null && after !== null) { state.energyLevel = Math.min(Math.max(Math.round((before + after) / 2), 0), 100); if(domElements.energyValue) domElements.energyValue.textContent = state.energyLevel; saveData(['energyLevel']); } }
        function checkDailyReset() { /* ... (no changes) ... */ const today = new Date().toISOString().split('T')[0]; if (state.lastPlayedDate === today) { resetDailySpinsIfNeeded(today); clearChallengeCompletionFlagIfNeeded(today); return; } resetDailySpinsIfNeeded(today); clearChallengeCompletionFlagIfNeeded(today); if (!state.lastPlayedDate) { state.consecutiveDays = 0; state.weeklyStreak = 0; console.log("First play."); return; } const todayD = new Date(today); const lastD = new Date(state.lastPlayedDate); const diffT = todayD.getTime() - lastD.getTime(); const diffD = Math.round(diffT / 86400000); if (diffD > 1) { state.consecutiveDays = 0; state.weeklyStreak = 0; console.log("Missed days, reset streaks."); saveData(['consecutiveDays', 'weeklyStreak']); } updateDailyCheckInButtonState(); }
        function clearChallengeCompletionFlagIfNeeded(today) { /* ... (no changes) ... */ if(state.challengeCompletedToday[today]) { delete state.challengeCompletedToday[today]; console.log(`Cleared challenge flag for ${today}.`); saveData(['challengeCompletedToday']); } const y = new Date(); y.setDate(y.getDate() - 1); const yStr = y.toISOString().split('T')[0]; let chg = false; for (const k in state.challengeCompletedToday) { if (k !== today && k !== yStr) { delete state.challengeCompletedToday[k]; chg = true; } } if(chg) saveData(['challengeCompletedToday']); }
        function resetDailySpinsIfNeeded(today) { /* ... (no changes) ... */ if (state.lastDailySpinReset !== today) { console.log("Resetting daily spins."); wheelTypes.forEach(t => { if (t !== 'referral') { state.wheelSpins[t] = 1; } }); state.lastDailySpinReset = today; saveData(['wheelSpins', 'lastDailySpinReset']); updateWheelButtonLabels(); updateWheelButtonsEnablement(); } }
        function dailyCheckIn() { /* ... (no changes) ... */ const now = Date.now(); const dayMs = 86400000; if (state.lastCheckInTime && (now - state.lastCheckInTime < dayMs)) { showNotification('Checked in today.', 'warning'); return; } if(!domElements.dailyCheckInBtn) return; domElements.dailyCheckInBtn.disabled = true; domElements.dailyCheckInBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>'; const today = new Date().toISOString().split('T')[0]; let pts = 5; let weekly = false; resetDailySpinsIfNeeded(today); if (state.lastPlayedDate) { const lastD = new Date(state.lastPlayedDate); const todayD = new Date(today); const diffT = todayD.getTime() - lastD.getTime(); const diffD = Math.round(diffT / dayMs); if (diffD === 1) { state.consecutiveDays++; pts += Math.min(state.consecutiveDays, 5); if (state.consecutiveDays > 0 && state.consecutiveDays % 7 === 0) { state.weeklyStreak++; weekly = true; awardMysteryBox(1, "Weekly Streak"); } if (state.consecutiveDays >= 7) checkAndGrantAchievement('7_DAY_STREAK'); } else if (diffD > 1) { state.consecutiveDays = 1; state.weeklyStreak = 0; } else { if (state.lastPlayedDate !== today) state.consecutiveDays = 1; } } else { state.consecutiveDays = 1; state.weeklyStreak = 0; } checkAndGrantAchievement('FIRST_CHECKIN'); state.lastPlayedDate = today; state.lastCheckInTime = now; saveData(['lastPlayedDate', 'lastCheckInTime', 'consecutiveDays', 'weeklyStreak', 'achievements']); awardPoints(pts, "Daily Check-in"); updateUI(); let msg = `Checked in! Day ${state.consecutiveDays}.`; if(weekly) msg += ` Weekly Streak: ${state.weeklyStreak}!`; showNotification(msg, 'success'); }
        function startCountdown() { /* ... (no changes) ... */ if (window.checkinCountdownInterval) clearInterval(window.checkinCountdownInterval); if (!state.lastCheckInTime || !domElements.countdownDisplay) { if(domElements.countdownDisplay) domElements.countdownDisplay.textContent = 'Check-in available!'; updateDailyCheckInButtonState(); return; } const dayMs = 86400000; const end = state.lastCheckInTime + dayMs; function u() { const now = Date.now(); const left = end - now; if (left <= 0) { domElements.countdownDisplay.textContent = 'Check-in available!'; updateDailyCheckInButtonState(); clearInterval(window.checkinCountdownInterval); return; } const h = Math.floor(left / 3600000); const m = Math.floor((left % 3600000) / 60000); const s = Math.floor((left % 60000) / 1000); domElements.countdownDisplay.textContent = `Next check-in: ${h}h ${m}m ${s}s`; if(domElements.dailyCheckInBtn) { domElements.dailyCheckInBtn.disabled = true; domElements.dailyCheckInBtn.textContent = "Checked In"; } } u(); window.checkinCountdownInterval = setInterval(u, 1000); }

        // --- Challenges Logic ---
        function initializeChallenges() { /* ... (fixed points default) ... */ return Array.from({ length: 150 }, (_, i) => { const idx = i % dailyGoals.length; return { day: i + 1, goal: dailyGoals[idx].goal, meditation: dailyGoals[idx].meditation, task1: dailyGoals[idx].task1, task2: dailyGoals[idx].task2, points: dailyGoals[idx].points || 0, completed: false, }; }); }
        function getCompletedDaysCount(maxDay) { /* ... (no changes) ... */ return state.challenges.slice(0, maxDay).filter(ch => ch.completed).length; }
        function isChallengeUnlocked(days) { /* ... (no changes) ... */ switch (days) { case 7: return true; case 21: return getCompletedDaysCount(7) === 7; case 41: return getCompletedDaysCount(21) === 21; case 66: return state.workshopAccess && getCompletedDaysCount(41) === 41; case 150: return state.workshopAccess && getCompletedDaysCount(66) === 66; default: return false; } }
        function loadChallenges() { /* ... (no changes) ... */ if (!domElements.challengeOptions) return; const durs = [7, 21, 41, 66, 150]; const icons = { 7: 'fa-sun', 21: 'fa-seedling', 41: 'fa-star', 66: 'fa-moon', 150: 'fa-crown' }; const titles = { 7: 'Foundation', 21: 'Habit Building', 41: 'Deepening', 66: 'Integration', 150: 'Mastery' }; domElements.challengeOptions.innerHTML = ''; durs.forEach(d => { const unlocked = isChallengeUnlocked(d); const icon = icons[d] || 'fa-question-circle'; const title = titles[d] || `${d}-Day`; const workshop = d > 41; const prevDays = d === 21 ? 7 : (d === 41 ? 21 : (d === 66 ? 41 : (d === 150 ? 66 : 0))); const prevTitle = titles[prevDays] || `${prevDays}-Day`; const div = document.createElement('div'); div.className = `challenge-div ${unlocked ? '' : 'locked'}`; let content = `<i class="fas ${icon} challenge-icon"></i><h3>${d}-Day: ${title}</h3>`; if (unlocked) { content += `<button class="btn btn-custom start-challenge-btn mt-2" data-days="${d}">Begin ${title}</button>`; } else { if (workshop && !state.workshopAccess) { if (getCompletedDaysCount(prevDays) !== prevDays) { content += `<p class="warning-text">Complete ${prevTitle} first.</p>`; } else { content += `<p class="warning-text">Workshop Access Needed</p><button class="btn btn-custom enroll-btn mt-2" data-days="${d}" style="font-size: 0.9em;">Enroll</button><button class="btn btn-secondary attended-btn mt-2 ms-1" data-days="${d}" style="font-size: 0.9em;">Code</button>`; } } else if (workshop && state.workshopAccess) { content += `<p class="warning-text">Complete ${prevTitle} first.</p>`; } else { content += `<p class="warning-text">Complete ${prevTitle} first.</p>`; } } div.innerHTML = content; domElements.challengeOptions.appendChild(div); }); }
        function isPastMidnightDubai() { /* ... (no changes) ... */ try { const nowUtc = new Date(); const dubaiOffset = 4 * 60; const nowDubai = new Date(nowUtc.getTime() + (dubaiOffset * 60000)); return true; } catch (e) { console.error("Dubai time error:", e); return true; } } // SIMPLIFIED
        function displayDailyChallenges(days) { /* ... (no changes) ... */ if (!days || !domElements.dailyChallengeList || !domElements.challengeTitle) { showSection('wellnessManager'); return; } const titles = { 7: 'Foundation', 21: 'Habit Building', 41: 'Deepening', 66: 'Integration', 150: 'Mastery' }; domElements.challengeTitle.textContent = `${days}-Day Challenge: ${titles[days] || ''}`; domElements.dailyChallengeList.innerHTML = ''; let firstUncompIdx = state.challenges.slice(0, days).findIndex(ch => !ch.completed); if (firstUncompIdx === -1) firstUncompIdx = days; const today = new Date().toISOString().split('T')[0]; const pastMidnight = isPastMidnightDubai(); state.challenges.slice(0, days).forEach((ch, idx) => { const card = document.createElement('div'); card.className = 'challenge-div mb-2'; const prevComp = idx === 0 || state.challenges[idx - 1]?.completed; const isNext = idx === firstUncompIdx; const prevDoneToday = idx > 0 && state.challengeCompletedToday[today]; let canStart = false; let lockReason = ""; if (ch.completed) {} else if (isNext) { if (prevComp) { if (prevDoneToday && !pastMidnight) { lockReason = `<i class="fas fa-clock"></i> Available midnight (Dubai)`; } else { canStart = true; } } else { lockReason = `<i class="fas fa-lock"></i> Day ${ch.day - 1} first`; } } else { if (idx < firstUncompIdx) { lockReason = `Error`; } else { lockReason = `<i class="fas fa-lock"></i> Day ${firstUncompIdx + 1} first`; } } let content = `<h4 style="color:var(--challenge-description-color);font-size:1.1rem;">Day ${ch.day}: ${ch.goal}</h4>`; const pts = parseInt(ch.points) || 0; if (ch.completed) { content += `<p style="color:green;font-weight:bold;"><i class="fas fa-check-circle"></i> Done (+${pts} $twote)</p>`; } else if (canStart) { content += `<button class="btn btn-custom btn-sm mt-1 start-day-btn" data-day="${ch.day}">Start Day ${ch.day}</button>`; } else { content += `<p class="warning-text" style="font-size:0.9em;">${lockReason||'Locked'}</p>`; card.classList.add('locked'); } card.innerHTML = content; domElements.dailyChallengeList.appendChild(card); }); }
        function startChallenge(day) { /* ... (no changes) ... */ const ch = state.challenges.find(c => c.day === day); if (!ch || !energyLogModalInstance) return; state.currentChallengeDay = day; state.energyBefore = null; if(domElements.energyLogModalTitle) domElements.energyLogModalTitle.textContent = `Day ${day}: ${ch.goal} - Before`; if(domElements.energyLogPrompt) domElements.energyLogPrompt.textContent = "Log energy (0-100%)."; if(domElements.energySlider) domElements.energySlider.value = 50; if(domElements.energySliderValue) domElements.energySliderValue.textContent = '50%'; if(domElements.challengeTasks) domElements.challengeTasks.style.display = 'none'; if(domElements.proofWarning) domElements.proofWarning.style.display = 'none'; if(domElements.submitEnergyLog){ domElements.submitEnergyLog.textContent = 'Confirm & View Tasks'; domElements.submitEnergyLog.setAttribute('data-stage', 'before'); domElements.submitEnergyLog.disabled = false; } if(domElements.task1Proof) domElements.task1Proof.value = ''; if(domElements.task2Proof) domElements.task2Proof.value = ''; energyLogModalInstance.show(); }

        // --- Wheel Logic ---
        function drawWheelSegment(ctx, centerX, centerY, radius, startAngle, endAngle, color, text, textRadiusFactor = 0.6) { /* ... (no changes) ... */ ctx.fillStyle = color; ctx.beginPath(); ctx.moveTo(centerX, centerY); ctx.arc(centerX, centerY, radius, startAngle, endAngle); ctx.closePath(); ctx.fill(); ctx.strokeStyle = 'rgba(0,0,0,0.2)'; ctx.lineWidth = 1; ctx.stroke(); ctx.save(); ctx.translate(centerX, centerY); const angle = startAngle + (endAngle - startAngle) / 2; ctx.rotate(angle); ctx.textAlign = 'center'; ctx.fillStyle = '#333'; const fs = Math.max(Math.min(radius / 11, 13), 8); ctx.font = `bold ${fs}px Nunito`; ctx.fillText(text, radius * textRadiusFactor, fs * 0.3); ctx.restore(); } // Adjusted text drawing slightly

        function drawWheel(wheelType, rotationAngle = 0) { // <<-- FIX IS HERE
            const canvas = domElements.wheelCanvas; if (!canvas) return; const ctx = canvas.getContext('2d'); const rewards = wheelRewardConfigs[wheelType]; if (!rewards) return;
            const numSegments = rewards.length; const anglePerSegment = (2 * Math.PI) / numSegments; const centerX = canvas.width / 2; const centerY = canvas.height / 2; const radius = Math.min(centerX, centerY) - 5; ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.save(); ctx.translate(centerX, centerY); ctx.rotate(rotationAngle); ctx.translate(-centerX, -centerY);
            rewards.forEach((segment, index) => { const startAngle = index * anglePerSegment - Math.PI / 2 - anglePerSegment / 2; const endAngle = startAngle + anglePerSegment; drawWheelSegment(ctx, centerX, centerY, radius, startAngle, endAngle, segment.color || '#eee', segment.label); });

            // Use hardcoded color value from CSS variable --wheel-border-color: #FFD700;
            const borderColor = "#FFD700"; // <<< FIX

            ctx.strokeStyle = borderColor; // <<< FIX
            ctx.lineWidth = 4;
            ctx.beginPath(); ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI); ctx.stroke();
            ctx.fillStyle = borderColor; // <<< FIX
            ctx.beginPath(); ctx.arc(centerX, centerY, radius * 0.1, 0, 2 * Math.PI); ctx.fill();
            ctx.restore();
        } // <<-- END OF FIX

        function showWheelModal(wheelType) { /* ... (no changes) ... */ currentWheelType = wheelType; if (!wheelRewardConfigs[currentWheelType]) { showNotification("Invalid wheel.", "error"); return; } const now = Date.now(); const dayMs = 86400000; const checkedIn = state.lastCheckInTime && (now - state.lastCheckInTime < dayMs); const spins = state.wheelSpins[currentWheelType] || 0; if (!checkedIn) { showNotification('Check-In first!', 'warning'); return; } if (spins <= 0) { showNotification(`No ${capitalizeFirstLetter(wheelType)} spins left.`, 'warning'); return; } if (!wheelModalInstance || !domElements.wheelModalTitle || !domElements.wheelResult || !domElements.spinTheWheelBtn || !domElements.wheelCanvas) { console.error("Wheel modal elements missing."); return; } domElements.wheelModalTitle.textContent = `${capitalizeFirstLetter(wheelType)} Wheel`; domElements.wheelResult.textContent = `Ready? ${spins} spin(s) left.`; domElements.spinTheWheelBtn.disabled = false; wheelSpinning = false; drawWheel(currentWheelType, currentRotation); wheelModalInstance.show(); }
        function triggerSpin() { /* ... (no changes) ... */ if (wheelSpinning || !currentWheelType || !domElements.spinTheWheelBtn || !domElements.wheelResult) return; const spins = state.wheelSpins[currentWheelType] || 0; if (spins <= 0) { showNotification(`No spins left.`, 'error'); domElements.spinTheWheelBtn.disabled = true; return; } wheelSpinning = true; domElements.spinTheWheelBtn.disabled = true; domElements.wheelResult.textContent = 'Spinning...'; state.wheelSpins[currentWheelType]--; saveData(['wheelSpins']); updateWheelButtonLabels(); updateReferralSpinsUI(); const rewards = wheelRewardConfigs[currentWheelType]; const numSegs = rewards.length; const angleSeg = (2 * Math.PI) / numSegs; const minRot = 5; const maxExtra = 8; const duration = Math.random() * 2000 + 3000; const totalRot = minRot + Math.random() * maxExtra; const stopAngle = Math.random() * 2 * Math.PI; const targetRot = totalRot * 2 * Math.PI + stopAngle; const startT = performance.now(); function easeOutCubic(t){ return 1-Math.pow(1-t,3); } function animate(time) { const elapsed = time - startT; let progress = Math.min(elapsed / duration, 1); progress = easeOutCubic(progress); const rot = currentRotation + progress * (targetRot - currentRotation); drawWheel(currentWheelType, rot); if (progress < 1) { requestAnimationFrame(animate); } else { currentRotation = rot % (2 * Math.PI); const winAngle = (currentRotation + Math.PI / 2 + angleSeg / 2) % (2 * Math.PI); const winIdx = Math.floor(winAngle / angleSeg); const winner = rewards[winIdx % numSegs]; applyReward(winner); setTimeout(() => { wheelSpinning = false; const remSpins = state.wheelSpins[currentWheelType] || 0; if(domElements.spinTheWheelBtn) domElements.spinTheWheelBtn.disabled = remSpins <= 0; if(domElements.wheelResult) domElements.wheelResult.innerHTML += remSpins <= 0 ? ` <br/>No more spins.` : ` <br/>${remSpins} spin(s) left.`; }, 1000); } } requestAnimationFrame(animate); }
        function applyReward(reward) { /* ... (no changes) ... */ if (!reward || !domElements.wheelResult) { if(domElements.wheelResult) domElements.wheelResult.textContent = 'Spin Error.'; return; } let msg = `Won: ${reward.label}!`; switch (reward.type) { case 'points': awardPoints(reward.value, `${capitalizeFirstLetter(currentWheelType)} Wheel`); break; case 'energy': state.energyLevel = Math.min(100, state.energyLevel + reward.value); saveData(['energyLevel']); msg += ` (+${reward.value}% NRG)`; updateUI(); break; case 'mystery_box': awardMysteryBox(reward.value, `${capitalizeFirstLetter(currentWheelType)} Wheel`); break; case 'message': break; case 'spin_again': msg += ` Spin again!`; state.wheelSpins[currentWheelType]++; saveData(['wheelSpins']); updateWheelButtonLabels(); updateReferralSpinsUI(); setTimeout(triggerSpin, 1500); break; default: console.warn("Unknown reward:", reward.type); } domElements.wheelResult.textContent = msg; }

        // --- Other Game Actions ---
        function awardMysteryBox(count = 1, reason = "") { /* ... (no changes) ... */ if(isNaN(count) || count < 1) count = 1; state.mysteryBoxes += count; console.log(`+${count} M.Box. Reason: ${reason}. Total: ${state.mysteryBoxes}`); saveData(['mysteryBoxes']); showNotification(`+${count} Mystery Box! 🎁`, 'success'); updateMysteryBoxUI(); }
        function openMysteryBox() { /* ... (no changes) ... */ if (state.mysteryBoxes <= 0) { showNotification("No Boxes.", 'warning'); return; } if(!domElements.openMysteryBoxBtn) return; domElements.openMysteryBoxBtn.disabled = true; state.mysteryBoxes--; const rewards = [ { type: 'points', value: 15 }, { type: 'points', value: 25 }, { type: 'points', value: 50 }, { type: 'spin', wheel: 'referral', value: 1 }, { type: 'energy', value: 5 } ]; const r = rewards[Math.floor(Math.random() * rewards.length)]; let msg = "Box: "; if (r.type === 'points') { msg += `${r.value} $twote!`; awardPoints(r.value, "Mystery Box"); } else if (r.type === 'spin') { msg += `${r.value} bonus ${capitalizeFirstLetter(r.wheel)} spin!`; state.wheelSpins[r.wheel] = (state.wheelSpins[r.wheel] || 0) + r.value; saveData(['wheelSpins']); updateReferralSpinsUI(); } else if (r.type === 'energy') { msg += `+${r.value}% Energy!`; state.energyLevel = Math.min(100, state.energyLevel + r.value); saveData(['energyLevel']); } checkAndGrantAchievement('OPEN_MYSTERY_BOX'); saveData(['mysteryBoxes', 'achievements']); showNotification(msg, 'success'); updateMysteryBoxUI(); updateUI(); }
        function checkAndGrantAchievement(key) { /* ... (no changes) ... */ if (!achievementsConfig[key]) return; if (!state.achievements.includes(key)) { state.achievements.push(key); const a = achievementsConfig[key]; console.log(`Achieved: ${a.name}`); showNotification(`Achieved: ${a.name}! 🏅`, 'success'); saveData(['achievements']); updateAchievementsUI(); } }
        function loadProfileHistory() { /* ... (no changes) ... */ if (!domElements.profileHistory) return; const hist = state.challengeHistory.slice(-15).reverse(); if (hist.length === 0) { domElements.profileHistory.innerHTML = '<tr><td colspan="6" class="text-center">No history.</td></tr>'; return; } domElements.profileHistory.innerHTML = hist.map(e => `<tr><td>${e.day}</td><td>${e.goal}</td><td>${e.energyBefore}%</td><td>${e.energyAfter}%</td><td class="text-center">${e.task1ProofProvided?'<i class="fas fa-check text-success"></i>':'-'}</td><td class="text-center">${e.task2ProofProvided?'<i class="fas fa-check text-success"></i>':'-'}</td></tr>`).join(''); }
        function deleteProgress() { /* ... (no changes) ... */ const conf = confirm('Delete ALL progress? Cannot be undone.'); if (conf) { console.log("Deleting progress."); document.body.insertAdjacentHTML('beforeend', '<div id="temp-loading" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:9999;color:white;">Deleting...</div>'); const uid=state.userId; const un=state.userName; const up=state.userPhoto; state=initializeState(); state.userId=uid; state.userName=un; state.userPhoto=up; ensureUserInLeaderboard(); const keys = [ 'energyLevel','points','level','challenges','challengeHistory','birthdate','consecutiveDays','weeklyStreak','lastPlayedDate','lastCheckInTime','completedTasks','workshopAccess','leaderboard','achievements','mysteryBoxes','wheelSpins','lastDailySpinReset','challengeCompletedToday']; try { keys.forEach(k => localStorage.removeItem(k)); saveData(['leaderboard','level','challenges','wheelSpins','challengeCompletedToday']); console.log("Progress deleted."); showNotification('Progress reset.', 'success'); updateUI(); loadProfileHistory(); showInitialSection(); } catch (err) { console.error("Delete error:", err); showNotification('Delete failed.', 'error'); } finally { const l=document.getElementById('temp-loading'); if(l) l.remove(); } } else { console.log("Deletion cancelled."); } }
        function completeTask(key) { /* ... (no changes) ... */ if (state.completedTasks.includes(key)) { showNotification('Task done.', 'info'); return; } const btn = domElements[`${key}TaskBtn`]; if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>'; } setTimeout(() => { state.completedTasks.push(key); saveData(['completedTasks']); awardPoints(10, `Task ${key}`); showNotification(`Task '${key}' done! +10 $twote`, 'success'); updateTaskButtons(); }, 1500); }
        function simulateReferralCompletion() { /* ... (no changes) ... */ console.log("Simulating referral..."); awardPoints(20, "Referral Sim"); const spins = 3; state.wheelSpins.referral = (state.wheelSpins.referral || 0) + spins; checkAndGrantAchievement('FIRST_REFERRAL'); saveData(['wheelSpins', 'achievements']); showNotification(`Referral sim! +20 $twote & +${spins} Spins!`, 'success'); updateUI(); }
        function copyReferralLink() { /* ... (no changes) ... */ const inp = domElements.referralLink; if (!inp || !inp.value || inp.value === "Link unavailable") { showNotification('Link unavailable.', 'error'); return; } navigator.clipboard.writeText(inp.value).then(() => { showNotification('Link copied!', 'success'); }).catch(err => { console.error('Copy failed:', err); showNotification('Copy failed.', 'error'); }); }
        function saveHoroscope() { /* ... (no changes) ... */ if(!domElements.birthdate) return; const bd = domElements.birthdate.value; if (bd) { state.birthdate = bd; saveData(['birthdate']); showSection('wellnessManager'); } else { showNotification('Enter birthdate.', 'error'); domElements.birthdate.focus(); } }
        function showEnrollModal(days) { /* ... (no changes) ... */ if (!enrollModalInstance || !domElements.enrollName || !domElements.enrollEnergy || !domElements.submitEnrollment || !domElements.enrollRequirement) return; domElements.enrollName.textContent = state.userName; domElements.enrollEnergy.textContent = state.energyLevel; const can = state.energyLevel >= 70; domElements.submitEnrollment.disabled = !can; domElements.enrollRequirement.style.display = can ? 'none' : 'block'; domElements.submitEnrollment.onclick = () => enroll(days); enrollModalInstance.show(); }
        function enroll(days) { /* ... (no changes) ... */ if (state.energyLevel < 70) { showNotification('Need 70% Energy!', 'error'); return; } state.workshopAccess = true; saveData(['workshopAccess']); enrollModalInstance.hide(); loadChallenges(); showNotification(`Enrolled!`, 'success'); }
        function showCodeModal(days) { /* ... (no changes) ... */ if (!codeModalInstance || !domElements.workshopCode || !domElements.submitCode) return; domElements.workshopCode.value = ''; domElements.submitCode.onclick = () => submitCode(days); codeModalInstance.show(); }
        function submitCode(days) { /* ... (no changes) ... */ if (!domElements.workshopCode) return; const code = domElements.workshopCode.value.trim(); if (code.toLowerCase() === "wellness") { state.workshopAccess = true; saveData(['workshopAccess']); codeModalInstance.hide(); loadChallenges(); showNotification(`Code accepted!`, 'success'); } else { showNotification('Invalid code.', 'error'); domElements.workshopCode.focus(); } }

        // --- Event Listeners Setup ---
        function setupEventListeners() { /* ... (no changes) ... */
            console.log("Setting up listeners..."); domElements.profileLink?.addEventListener('click', () => showSection('playerProfile')); domElements.saveHoroscopeBtn?.addEventListener('click', saveHoroscope);
            domElements.navHome?.addEventListener('click', (e) => { e.preventDefault(); showSection('wellnessManager'); }); domElements.navTasks?.addEventListener('click', (e) => { e.preventDefault(); showSection('tasksSection'); }); domElements.navGame?.addEventListener('click', (e) => { e.preventDefault(); showSection('gamePage'); }); domElements.navProfile?.addEventListener('click', (e) => { e.preventDefault(); showSection('playerProfile'); });
            domElements.dailyCheckInBtn?.addEventListener('click', dailyCheckIn); domElements.openMysteryBoxBtn?.addEventListener('click', openMysteryBox); domElements.claimReferralRewardBtn?.addEventListener('click', simulateReferralCompletion); domElements.copyReferralBtn?.addEventListener('click', copyReferralLink);
            domElements.telegramTaskBtn?.addEventListener('click', () => completeTask('telegram')); domElements.twitterTaskBtn?.addEventListener('click', () => completeTask('twitter')); domElements.instagramTaskBtn?.addEventListener('click', () => completeTask('instagram')); domElements.youtubeTaskBtn?.addEventListener('click', () => completeTask('youtube'));
            const wg = document.querySelector('.wheel-button-grid'); wg?.addEventListener('click', (e) => { const b = e.target.closest('button.wheel-button'); if (b && b.dataset.wheel) showWheelModal(b.dataset.wheel); });
            domElements.spinTheWheelBtn?.addEventListener('click', triggerSpin); domElements.deleteProgressBtn?.addEventListener('click', deleteProgress); domElements.connectWalletBtn?.addEventListener('click', () => showNotification('Wallet connect soon!', 'info')); domElements.airdropWithdrawBtn?.addEventListener('click', () => showNotification('Withdrawal soon!', 'info'));
            domElements.challengeOptions?.addEventListener('click', (e) => { const t = e.target; if (t.classList.contains('start-challenge-btn')) { const d = parseInt(t.dataset.days); if (!isNaN(d)) { state.currentChallengeDuration = d; showSection('dailyChallenges'); } } else if (t.classList.contains('enroll-btn')) { const d = parseInt(t.dataset.days); if (!isNaN(d)) showEnrollModal(d); } else if (t.classList.contains('attended-btn')) { const d = parseInt(t.dataset.days); if (!isNaN(d)) showCodeModal(d); } });
            domElements.dailyChallengeList?.addEventListener('click', (e) => { if (e.target.classList.contains('start-day-btn')) { const d = parseInt(e.target.dataset.day); if (!isNaN(d)) startChallenge(d); } });
            domElements.energySlider?.addEventListener('input', () => { if(domElements.energySliderValue) domElements.energySliderValue.textContent = `${domElements.energySlider.value}%`; });
            [domElements.task1Proof, domElements.task2Proof].forEach(i => { i?.addEventListener('change', () => { if (domElements.submitEnergyLog?.getAttribute('data-stage') === 'after') { const f1 = domElements.task1Proof?.files[0]; const f2 = domElements.task2Proof?.files[0]; if(domElements.submitEnergyLog) domElements.submitEnergyLog.disabled = !(f1 && f2); if(domElements.proofWarning) domElements.proofWarning.style.display = (f1 && f2) ? 'none' : 'block'; } }); });
            domElements.submitEnergyLog?.addEventListener('click', () => { if (!energyLogModalInstance) return; const v = parseInt(domElements.energySlider?.value || '50'); const s = domElements.submitEnergyLog?.getAttribute('data-stage'); const ch = state.challenges.find(c => c.day === state.currentChallengeDay); if (!ch) { energyLogModalInstance.hide(); return; } domElements.submitEnergyLog.disabled = true; if (s === 'before') { state.energyBefore = v; if(domElements.energyLogModalTitle) domElements.energyLogModalTitle.textContent = `Day ${state.currentChallengeDay}: ${ch.goal} - After`; if(domElements.energyLogPrompt) domElements.energyLogPrompt.textContent = "Complete tasks & log energy."; if(domElements.challengeTasks) domElements.challengeTasks.style.display = 'block'; if(domElements.meditationTask) domElements.meditationTask.textContent = ch.meditation; if(domElements.task1Text) domElements.task1Text.textContent = ch.task1; if(domElements.task2Text) domElements.task2Text.textContent = ch.task2; if(domElements.energySlider) domElements.energySlider.value = 50; if(domElements.energySliderValue) domElements.energySliderValue.textContent = '50%'; if(domElements.task1Proof) domElements.task1Proof.value = ''; if(domElements.task2Proof) domElements.task2Proof.value = ''; if(domElements.submitEnergyLog){ domElements.submitEnergyLog.textContent = 'Submit Completion'; domElements.submitEnergyLog.setAttribute('data-stage', 'after'); domElements.submitEnergyLog.disabled = true; } if(domElements.proofWarning) domElements.proofWarning.style.display = 'block'; } else if (s === 'after') { const ea = v; const f1 = domElements.task1Proof?.files[0]; const f2 = domElements.task2Proof?.files[0]; if (!f1 || !f2) { showNotification('Upload proof.', 'error'); domElements.submitEnergyLog.disabled = false; if(domElements.proofWarning) domElements.proofWarning.style.display = 'block'; return; } domElements.submitEnergyLog.innerHTML = '<span class="spinner-border spinner-border-sm"></span>'; setTimeout(() => { try { ch.completed = true; const today = new Date().toISOString().split('T')[0]; state.challengeCompletedToday[today] = true; state.challengeHistory.push({ day: state.currentChallengeDay, goal: ch.goal, energyBefore: state.energyBefore, energyAfter: ea, task1ProofProvided: true, task2ProofProvided: true }); updateEnergyLevel(state.energyBefore, ea); const pts = parseInt(ch.points) || 0; awardPoints(pts, `Challenge Day ${state.currentChallengeDay}`); if(state.currentChallengeDuration === 7 && getCompletedDaysCount(7) === 7) checkAndGrantAchievement('CHALLENGE_7_COMPLETE'); saveData(['challenges', 'challengeHistory', 'energyLevel', 'points', 'leaderboard', 'level', 'achievements', 'challengeCompletedToday']); energyLogModalInstance.hide(); showNotification(`Day ${state.currentChallengeDay} done! 🎉`, 'success'); displayDailyChallenges(state.currentChallengeDuration); } catch (err) { console.error("Submit error:", err); showNotification('Submit error.', 'error'); domElements.submitEnergyLog.textContent = 'Submit'; domElements.submitEnergyLog.disabled = false; } }, 100); } });
            setupBackButton(); console.log("Listeners setup done.");
        }

    </script>
</body>
</html>
